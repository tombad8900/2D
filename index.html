<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>

<title>WAR-CORE ULTIMATE</title>

<style>
html,body{
margin:0;
height:100%;
background:#000;
overflow:hidden;
font-family:system-ui;
}

canvas{display:block}

/* admin */
#panel{
position:fixed;
top:0;
left:0;
right:0;
background:#050505ee;
border-bottom:2px solid #600;
padding:10px;
transform:translateY(-110%);
transition:.25s;
z-index:9999;
}

body.admin #panel{
transform:translateY(0);
}

textarea{
width:60%;
height:80px;
background:#000;
color:#fff;
border:1px solid #222;
}

button{
background:#111;
color:#fff;
border:1px solid #333;
padding:8px;
cursor:pointer;
}

#secret{
position:fixed;
bottom:0;
left:0;
width:50px;
height:50px;
}
</style>
</head>
<body>

<div id="panel">
<textarea id="msg"></textarea>
<button id="fetch">FETCH</button>
<button id="gridBtn">GRID</button>
<button id="voidBtn">VOID</button>
<input type="file" id="img">
</div>

<div id="secret"></div>

<canvas id="c"></canvas>

<script>
"use strict";

/* =====================
   CONSTANTS
===================== */

const RAW_URL="https://gist.githubusercontent.com/tombad8900/02c19d224a9d2cafc91bf918c81e27a6/raw/";
const DPR_MAX=2;

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d",{alpha:false,desynchronized:true}) || canvas.getContext("2d");

let back=document.createElement("canvas");
let bctx=back.getContext("2d");

/* =====================
   STATE
===================== */

let w=0,h=0,dpr=1;

let grid,scan,noise;
let matrixDrops=[];
let lines=["WAR-CORE ACTIVE"];

let bgMode="grid";
let uploadedImg=null;

let glitch=0;
let raf;
let last=performance.now();

/* =====================
   RESIZE
===================== */

function resize(){

dpr=Math.min(devicePixelRatio||1,DPR_MAX);

w=innerWidth;
h=innerHeight;

canvas.width=w*dpr;
canvas.height=h*dpr;

canvas.style.width=w+"px";
canvas.style.height=h+"px";

back.width=w;
back.height=h;

ctx.setTransform(dpr,0,0,dpr,0,0);

buildGrid();
buildScan();
buildNoise();
initMatrix();
}

addEventListener("resize",debounce(resize,120));

/* =====================
   CACHES
===================== */

function buildGrid(){

grid=document.createElement("canvas");
grid.width=w;
grid.height=h;

const g=grid.getContext("2d");

const spacing=Math.max(20,Math.min(w,h)*0.04);

g.strokeStyle="rgba(0,255,120,.05)";

for(let x=0;x<w;x+=spacing){
g.beginPath();
g.moveTo(x,0);
g.lineTo(x,h);
g.stroke();
}

for(let y=0;y<h;y+=spacing){
g.beginPath();
g.moveTo(0,y);
g.lineTo(w,y);
g.stroke();
}
}

function buildScan(){

scan=document.createElement("canvas");
scan.width=w;
scan.height=h;

const s=scan.getContext("2d");

s.fillStyle="rgba(0,0,0,.08)";

for(let y=0;y<h;y+=4){
s.fillRect(0,y,w,1);
}
}

function buildNoise(){

noise=document.createElement("canvas");
noise.width=220;
noise.height=220;

const n=noise.getContext("2d");
const img=n.createImageData(220,220);

for(let i=0;i<img.data.length;i+=4){
const v=Math.random()*255;
img.data[i]=v;
img.data[i+1]=v;
img.data[i+2]=v;
img.data[i+3]=12;
}

n.putImageData(img,0,0);
}

/* =====================
   MATRIX
===================== */

function initMatrix(){

matrixDrops=[];

const font=16;

for(let i=0;i<w/font;i++){
matrixDrops[i]=Math.random()*-h;
}
}

function drawMatrix(ctx){

const font=16;
ctx.font=`${font}px monospace`;
ctx.fillStyle="rgba(0,200,0,.75)";

for(let i=0;i<matrixDrops.length;i++){

const x=i*font;
const y=matrixDrops[i];

ctx.fillText(Math.random()>.5?"0":"1",x,y);

if(y>h && Math.random()>.975)
matrixDrops[i]=0;

matrixDrops[i]+=1.2;
}
}

/* =====================
   TEXT
===================== */

function drawText(ctx){

if(!lines.length) return;

let fs=Math.min(w*.12,(h*.8)/(lines.length*1.2));
ctx.font=`900 ${Math.floor(fs)}px system-ui`;

let widest=0;

for(const l of lines){
widest=Math.max(widest,ctx.measureText(l).width);
}

if(widest>w*.9){
fs*=w*.9/widest;
ctx.font=`900 ${Math.floor(fs)}px system-ui`;
}

const lh=fs*1.2;
const startY=h/2-(lines.length*lh)/2+lh/2;

ctx.textAlign="center";
ctx.textBaseline="middle";

lines.forEach((line,i)=>{

const y=startY+i*lh;
const x=w/2;
const shift=Math.max(1,fs*.015);

// aberration
ctx.fillStyle="rgba(255,0,0,.75)";
ctx.fillText(line,x-shift,y);

ctx.fillStyle="rgba(0,255,255,.75)";
ctx.fillText(line,x+shift,y);

// main
ctx.lineWidth=fs*.06;
ctx.strokeStyle="#000";
ctx.fillStyle="#fff";

ctx.strokeText(line,x,y);
ctx.fillText(line,x,y);

});
}

/* =====================
   FETCH
===================== */

async function fetchPayload(){

try{

const res=await fetch(RAW_URL+"?t="+Date.now(),{cache:"no-store"});
const txt=await res.text();

lines=txt.split("\n").filter(l=>l.trim());

glitch=20;

}catch{
lines=["CONNECTION LOST"];
}
}

/* =====================
   LOOP
===================== */

function render(t){

const dt=t-last;
last=t;

bctx.fillStyle="#000";
bctx.fillRect(0,0,w,h);

if(bgMode==="grid")
bctx.drawImage(grid,0,0);

if(uploadedImg){
const scale=Math.max(w/uploadedImg.width,h/uploadedImg.height);
const dw=uploadedImg.width*scale;
const dh=uploadedImg.height*scale;

bctx.filter="grayscale(100%) brightness(60%)";
bctx.drawImage(uploadedImg,(w-dw)/2,(h-dh)/2,dw,dh);
bctx.filter="none";
}

drawMatrix(bctx);
drawText(bctx);

bctx.drawImage(scan,0,0);

bctx.globalAlpha=.22;
bctx.drawImage(noise,0,0,w,h);
bctx.globalAlpha=1;

ctx.drawImage(back,0,0);

raf=requestAnimationFrame(render);
}

/* =====================
   ADMIN
===================== */

document.getElementById("secret").onclick=()=>{
document.body.classList.toggle("admin");
};

document.getElementById("fetch").onclick=fetchPayload;

document.getElementById("msg").oninput=e=>{
lines=e.target.value.split("\n");
};

document.getElementById("gridBtn").onclick=()=>bgMode="grid";
document.getElementById("voidBtn").onclick=()=>bgMode="void";

document.getElementById("img").onchange=e=>{
const file=e.target.files[0];
if(!file) return;

const img=new Image();
img.onload=()=>uploadedImg=img;
img.src=URL.createObjectURL(file);
};

/* =====================
   HELPERS
===================== */

function debounce(fn,ms){
let t;
return(...a)=>{
clearTimeout(t);
t=setTimeout(()=>fn(...a),ms);
};
}

/* =====================
   START
===================== */

resize();
fetchPayload();
raf=requestAnimationFrame(render);

</script>
</body>
</html>
